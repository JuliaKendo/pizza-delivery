# Магазин доставки в Телеграмме и Facebook

Бот умеет продавать товары в telegram и facebook. В качестве примера реализована доставка пиццы. Бот интегрирован с CMS [Moltin](https://www.moltin.com/). Так же бот использует базу данных на [Redislabs](https://redislabs.com). Бот позволяет оформлять заказ клиента прямо в окне диалога мессенджера. Бот в telegram имеет дополнительные функции, после заполнения корзины, идет этап указания номера телефона и адреса. Удобной функцией бота является возможность отправить геопозицию. Еще одна полезная фишка - информирование курьера куда доставлять заказ. Бот умеет принимать оплату банковской картой. В боте есть таймер, который информирует покупателя о том, что прошел час с момента заказа.


![Alt text](demo/pizza-shop-demo.gif) | ![Alt text](demo/fb-shop-demo.gif)
-------------------------------       |-------------------------------

## Установка и запуск

Python3 должен быть уже установлен. Затем используйте pip (или pip3, если есть конфликт с Python2) для установки зависимостей:

```
pip install -r requirements.txt
```

Создайте базу данных на [Redislabs](https://redislabs.com).

Создайте новый магазин в [Moltin](https://dashboard.elasticpath.com/stores).

Для установки создайте файл .env, в котором заполните следующие переменные окружения:
- `TG_ACCESS_TOKEN` - Секретный ключ бота telegram для магазина.
- `TG_LOG_TOKEN` - Секретный ключ бота для информации об ошибках.
- `TG_CHAT_ID` - ID чата текущего пользователя telegram.
- `MOLTIN_CLIENT_SECRET` - Секретный токен магазина в CMS [Moltin](https://www.moltin.com/).
- `MOLTIN_CLIENT_ID` - Client ID магазина в CMS [Moltin](https://www.moltin.com/).
- `REDIS_HOST` - Адрес базы данных redis.
- `REDIS_PORT` - Порт для подключения к базе данных redis.
- `REDIS_PASSWORD` - Пароль для подключения к базе данных redis.
- `YANDEX_API_KEY` - API ключ [yandex геокодер](https://developer.tech.yandex.ru/services/).
- `PAYMENT_TOKEN` - Токен провайдера платежей.
- `HEROKU_URL` - URL доступный после деплоя на сервер [HEROKU](https://heroku.com).
- `PORT` - Порт веб сервера [HEROKU](https://heroku.com).
- `FACEBOOK_VERIFY_TOKEN` - Маркер, который Facebook вернет вам в рамках подтверждения URL обратного вызова.
- `MOTLIN_VERIFY_TOKEN` - Маркер, который Motlin возвращает в рамках webhook сообщения.
- `FACEBOOK_TOKEN` - Маркер доступа facebook.

В CMS Moltin должны быть созданы модели и поля, а также загружена информация о продуктах и адресах. Скрипт motlin_load.py делает это автоматически. 
Для загрузки необходимы json файлы следующих форматов:
![Продукты](demo/menu-demo.png)|![Адреса](demo/addresses-demo.png)
--------------------------|-----------------------------

Запускают скрипт со следующими параметрами:
1. `-m, --models`      Путь к *.json файлу с описанием моделей.
2. `-с, --categories`  Путь к *.json файлу с категориями продуктов.
3. `-p, --products`    Путь к *.json файлу с продуктами.
4. `-a, --address`     Путь к *.json файлу с адресами.
```
python.exe motlin_load.py -m models.json -p menu.json -a addresses.json
```	
Файл `models.json` и `categories.json` присутствует в составе скрипта.


Cкрипт запуска telegram бота без параметров:

```
python.exe tg_bot.py
```	

Cкрипт facebook бота запускают со следующими необязательными параметрами:
1. `-d, --debug`      При указании данного ключа сервер Flask запускается в режиме отладки.

```
python.exe fb_bot.py -d
```	

Информацию о ходе выполнения скрипт отправляют отдельному боту telegram. Токен его должен быть указан в соответствующей переменной окружения.
В составе скрипта присутствует файл `Procfile`, необходимый для деплоя на сервер [HEROKU](https://heroku.com). Файл уже настроен должным образом, поэтому перенос скрипта на сервер выполняется в соответствии с документацией сервера [HEROKU](https://devcenter.heroku.com/articles/git).


## Цель проекта

Код написан в образовательных целях, для изучения возможностей чат-ботов, на онлайн-курсе для веб-разработчиков [dvmn.org](https://dvmn.org).
